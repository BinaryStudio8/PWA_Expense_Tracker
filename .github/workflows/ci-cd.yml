name: CI/CD Pipeline

on:
  # Trigger CI on pushes to main/dev and on version tags like v1.2.3
  push:
    branches:
      - main
      - dev
    tags:
      - "v*.*.*"

  # Run CI checks on pull requests
  pull_request:
    branches: [main, dev]

  # Allow manual triggering
  workflow_dispatch:

# Prevent multiple concurrent runs for same branch/tag
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: "21"
  JAVA_DISTRIBUTION: "temurin"
  PREWARM_CACHE_PREFIX: "prewarm"

jobs:
  # ------------------------------------------------------------
  # 1. Secret Scan (safety gate) ðŸ”’
  # ------------------------------------------------------------
  secret-scan:
    name: "ðŸ”’ Secret Scan"
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ðŸ” Scanning for secrets..."
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true

      - name: "âœ… Secret scan complete"
        run: echo "::notice::Secret scan completed successfully"

  # ------------------------------------------------------------
  # 2. Lint (ESLint) ðŸ“
  # ------------------------------------------------------------
  lint:
    name: "ðŸ“ Lint Code"
    runs-on: ubuntu-latest
    needs: secret-scan
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "âš¡ Setup Bun"
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.2"

      - name: "â™»ï¸ Restore Bun cache (prewarm)"
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.bun
          key: ${{ env.PREWARM_CACHE_PREFIX }}-bun-${{ runner.os }}-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ env.PREWARM_CACHE_PREFIX }}-bun-${{ runner.os }}-
            bun-cache-${{ hashFiles('bun.lockb') }}
            bun-cache-

      - name: "ðŸ“¦ Installing dependencies..."
        run: |
          echo "::group::Installing packages"
          bun install --frozen-lockfile
          echo "::endgroup::"

      - name: "â™»ï¸ Restore ESLint cache"
        uses: actions/cache@v4
        with:
          path: .eslintcache
          key: eslint-${{ github.sha }}
          restore-keys: eslint-

      - name: "ðŸ” Running ESLint..."
        run: |
          echo "::group::Linting files"
          bunx eslint . --cache --cache-location .eslintcache
          echo "::endgroup::"

      - name: "âœ… Linting complete"
        run: echo "::notice::All linting checks passed!"

  # ------------------------------------------------------------
  # 3. Type Check (TS) ðŸ”¤
  # ------------------------------------------------------------
  typecheck:
    name: "ðŸ”¤ Type Check"
    runs-on: ubuntu-latest
    needs: secret-scan
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "âš¡ Setup Bun"
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.2"

      - name: "â™»ï¸ Restore Bun cache (prewarm)"
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.bun
          key: ${{ env.PREWARM_CACHE_PREFIX }}-bun-${{ runner.os }}-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ env.PREWARM_CACHE_PREFIX }}-bun-${{ runner.os }}-
            bun-cache-

      - name: "ðŸ“¦ Installing dependencies..."
        run: |
          echo "::group::Installing packages"
          bun install --frozen-lockfile
          echo "::endgroup::"

      - name: "ðŸ” Running TypeScript compiler..."
        run: |
          echo "::group::Type checking"
          bunx tsc --noEmit
          echo "::endgroup::"

      - name: "âœ… Type check complete"
        run: echo "::notice::No type errors found!"

  # ------------------------------------------------------------
  # 4. Build Web (Vite) ðŸ—ï¸
  # ------------------------------------------------------------
  build-web:
    name: "ðŸ—ï¸ Build Web App"
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "âš¡ Setup Bun"
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.2"

      - name: "â™»ï¸ Restore Bun cache (prewarm)"
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.bun
          key: ${{ env.PREWARM_CACHE_PREFIX }}-bun-${{ runner.os }}-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ env.PREWARM_CACHE_PREFIX }}-bun-${{ runner.os }}-
            bun-cache-

      - name: "ðŸ“¦ Installing dependencies..."
        run: |
          echo "::group::Installing packages"
          bun install --frozen-lockfile
          echo "::endgroup::"

      - name: "ðŸ”¨ Building web app with Vite..."
        run: |
          echo "::group::Vite build"
          bun run build
          echo "::endgroup::"

      - name: "ðŸ“Š Build stats"
        run: |
          echo "::notice::Build completed successfully"
          du -sh dist/
          echo "Build size: $(du -sh dist/ | cut -f1)"

      - name: "ðŸ“¤ Upload build artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist/**
          retention-days: 7

      - name: "âœ… Web build complete"
        run: echo "::notice::Web assets ready for Android build"

  # ------------------------------------------------------------
  # 5. Build Android (SIGNED RELEASE APK) ðŸ“±
  # ------------------------------------------------------------
  build-android:
    name: "ðŸ“± Build Android APK"
    runs-on: ubuntu-latest
    needs: build-web
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "âš¡ Setup Bun"
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.2"

      - name: "â˜• Setup Java"
        uses: actions/setup-java@v5
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: "â™»ï¸ Restore Gradle cache (prewarm)"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ env.PREWARM_CACHE_PREFIX }}-gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ env.PREWARM_CACHE_PREFIX }}-gradle-${{ runner.os }}-
            gradle-

      - name: "ðŸ¤– Setup Android SDK"
        uses: android-actions/setup-android@v3

      - name: "ðŸ“¦ Install Android SDK components..."
        run: |
          echo "::group::Installing SDK"
          yes | sdkmanager --licenses >/dev/null || true
          sdkmanager "platform-tools" "platforms;android-36" "build-tools;36.0.0"
          echo "::endgroup::"

      - name: "ðŸ”‘ Restore signing keystore"
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "::group::Restoring keystore"
          mkdir -p android/app
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/release.keystore
          echo "::endgroup::"

      - name: "ðŸ” Export signing credentials"
        run: |
          echo "ANDROID_KEYSTORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "ANDROID_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> $GITHUB_ENV
          echo "ANDROID_KEY_ALIAS_PASSWORD=${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}" >> $GITHUB_ENV

      - name: "ðŸ“¦ Install JS dependencies..."
        run: |
          echo "::group::Installing packages"
          bun install --frozen-lockfile
          echo "::endgroup::"

      - name: "ðŸ“¥ Download web build artifacts"
        uses: actions/download-artifact@v6
        with:
          name: web-build
          path: dist/

      - name: "ðŸ”„ Sync Capacitor..."
        run: |
          echo "::group::Capacitor sync"
          echo "Step 1/2: Copying web assets..."
          bun run cap:copy
          echo "Step 2/2: Syncing native project..."
          bun run cap:sync
          echo "::endgroup::"

      - name: "ðŸ”§ Make gradlew executable"
        run: |
          chmod +x android/gradlew
          ls -la android/

      - name: "ðŸ” Pre-build debug (list key files)"
        run: |
          echo "PWD: $(pwd)"
          echo "Showing android dir:"
          ls -la android || true
          echo "Showing build.gradle files:"
          find android -maxdepth 2 -type f -name "build.gradle*" -print || true
          echo "Gradle wrapper jar:"
          ls -la android/gradle/wrapper || true

      - name: "âš™ï¸ Gradle version (wrapper)"
        run: |
          ./android/gradlew --version

      - name: "ðŸ—ï¸ Building signed release APK (full logs)"
        run: |
          set -o pipefail
          cd android
          echo "Starting Android build process..."
          ./gradlew assembleRelease --no-daemon --stacktrace --console=plain 2>&1 | tee ../gradle-build.log
          BUILD_EXIT=${PIPESTATUS[0]}
          echo "Gradle exit code: $BUILD_EXIT"
          if [ "$BUILD_EXIT" -ne 0 ]; then
            echo "::error::Gradle build failed. See gradle-build.log"
            exit $BUILD_EXIT
          fi

      - name: "ðŸ” Debug APK output directory"
        run: |
          echo "Listing outputs recursively:"
          ls -R android/app/build/outputs || true
          echo "Look for APK files:"
          find android/app/build/outputs -type f -name "*.apk" -print || true
          echo "List artifact dir root:"
          ls -la android/app/build/outputs/apk/release || true

      - name: "ðŸ“Š APK info (if present)"
        run: |
          set -e
          APK_PATTERN="android/app/build/outputs/apk/release/*.apk"
          echo "Pattern: $APK_PATTERN"
          shopt -s nullglob
          files=($APK_PATTERN)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No APK files found in release dir."
            exit 0
          fi
          for f in "${files[@]}"; do
            echo "Found APK: $f"
            du -h "$f"
          done

      - name: "ðŸ“¤ Upload build logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gradle-logs
          path: gradle-build.log

      - name: "ðŸ“¤ Upload APK(s) (signed or unsigned)"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: "âœ… Android build complete"
        run: echo "::notice::Android build job finished (check uploaded artifacts and gradle logs)"

  # ------------------------------------------------------------
  # 6. Release (ONLY for version tags) ðŸš€
  # ------------------------------------------------------------
  release:
    name: "ðŸš€ Create Release"
    runs-on: ubuntu-latest
    needs: build-android
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ðŸ“¥ Download APK artifact"
        uses: actions/download-artifact@v6
        with:
          name: android-apk
          path: artifacts/

      - name: "ðŸ“Š Release info"
        run: |
          echo "::notice::Preparing release for ${{ github.ref_name }}"
          APK_SIZE=$(du -h artifacts/app-release.apk | cut -f1)
          echo "APK Size: $APK_SIZE"

      # ------------------------------
      # Install git-cliff
      # ------------------------------
      - name: "ðŸ“¥ Install git-cliff"
        run: |
          LATEST=$(curl -s https://api.github.com/repos/orhun/git-cliff/releases/latest \
            | jq -r '.assets[] | select(.name | test("x86_64-unknown-linux-musl.tar.gz$")) | .browser_download_url')

          echo "Downloading git-cliff: $LATEST"
          curl -sSL "$LATEST" -o git-cliff.tar.gz

          tar -xzf git-cliff.tar.gz
          sudo mv git-cliff*/git-cliff /usr/local/bin/git-cliff

      # ------------------------------
      # Generate Changelog
      # ------------------------------
      - name: "ðŸ“ Generate changelog"
        run: |
          git-cliff --tag ${GITHUB_REF#refs/tags/} > RELEASE_CHANGELOG.md
          echo "Generated changelog:"
          cat RELEASE_CHANGELOG.md

      # ------------------------------
      # Publish GitHub Release
      # ------------------------------
      - name: "ðŸš€ Publish GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/app-release.apk
          body_path: RELEASE_CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "âœ… Release published"
        run: echo "::notice::Release ${{ github.ref_name }} published successfully!"